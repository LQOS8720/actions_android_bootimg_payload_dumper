name: get_images_from_payload.bin (Python version)
on:
  workflow_dispatch:
    inputs:
      UPLOAD_CONFIG:
        description: 'Upload to GitHub Artifacts (true) or GitHub Releases (false)'
        required: true
        default: "false"
        type: boolean
      ROM_URL:
        description: 'ROM direct link (must contain payload.bin)'
        required: true
        default: "https://ultimateota.d.miui.com/OS2.0.206.0.VLFCNXM/diting-ota_full-OS2.0.206.0.VLFCNXM-user-15.0-ffb9d90a59.zip?t=1764465831&s=6cb61215b740756331758beb4f6a5b3a"
        type: string
      PARTITIONS:
        description: 'Partitions to extract (e.g., boot,vendor_boot,dtbo)'
        required: true
        default: "boot"
        type: string

env:
  TZ: Asia/Shanghai

permissions:
  contents: write

jobs:
  make:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install payload-dumper (Python version)
        run: |
          pip install --no-cache-dir git+https://github.com/5ec1cff/payload-dumper

      - name: Create output directory
        run: mkdir -p extracted_images

      - name: Download ROM (if needed for local extraction)
        # æ³¨æ„ï¼špayload-dumper å¯ç›´æ¥ä» URL æå–ï¼Œä½†ä¸ºå…¼å®¹æ€§ï¼Œæˆ‘ä»¬ä»ä¸‹è½½
        run: |
          echo "ğŸ“¥ Downloading ROM..."
          wget --connect-timeout=10 --timeout=120 -O rom.zip "${{ github.event.inputs.ROM_URL }}"

      - name: List available partitions (debug)
        run: |
          echo "ğŸ” Listing partitions in ROM..."
          payload_dumper --list rom.zip

      - name: Extract specified partitions
        run: |
          cd extracted_images
          partitions="${{ github.event.inputs.PARTITIONS }}"
          echo "ğŸ”§ Extracting partitions: $partitions"
          payload_dumper --partitions "$partitions" ../rom.zip

      - name: Verify extracted .img files
        run: |
          cd extracted_images
          echo "ğŸ“ Files extracted:"
          ls -la
          img_files=(*.img)
          if [ ${#img_files[@]} -eq 0 ]; then
            echo "âŒ No .img files found!"
            exit 1
          else
            echo "âœ… Found ${#img_files[@]} image(s):"
            for f in "${img_files[@]}"; do
              echo "   - $f ($(stat -c%s "$f") bytes)"
            done
          fi

      - name: Upload to GitHub Artifacts (for debugging)
        if: ${{ github.event.inputs.UPLOAD_CONFIG == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: Extracted-Images
          path: extracted_images/*.img

      - name: Create GitHub Release and Upload Images
        if: ${{ github.event.inputs.UPLOAD_CONFIG == 'false' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "auto-${{ github.run_id }}-${{ github.run_number }}"
          name: "Extracted Images - Run #${{ github.run_number }}"
          body: |
            Partitions: `${{ github.event.inputs.PARTITIONS }}`
            Source ROM: `${{ github.event.inputs.ROM_URL }}`
            Tool: `5ec1cff/payload-dumper (Python)`
            Workflow: [View logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          draft: false
          prerelease: false
          files: extracted_images/*.img
