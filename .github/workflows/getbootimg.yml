name: get_images_from_payload.bin
on:
  workflow_dispatch:
    inputs:
      UPLOAD_CONFIG:
        description: 'Upload to GitHub Artifacts (true) or GitHub Releases (false)'
        required: true
        default: "false"
        type: boolean
      ROM_URL:
        description: 'ROM direct link (must contain payload.bin)'
        required: true
        default: "https://ultimateota.d.miui.com/OS2.0.206.0.VLFCNXM/diting-ota_full-OS2.0.206.0.VLFCNXM-user-15.0-ffb9d90a59.zip?t=1764465831&s=6cb61215b740756331758beb4f6a5b3a"
        type: string
      PARTITIONS:
        description: 'Partitions to extract (e.g., boot,vendor_dlkm,vendor_boot)'
        required: true
        default: "boot"
        type: string

env:
  TZ: Asia/Shanghai
  # ä½¿ç”¨ WOA-Project ç»´æŠ¤çš„ v1.3.0 ç‰ˆæœ¬ï¼Œæ”¯æŒ HyperOS / MIUI 14+
  Payload_Dumper_Go_Url: https://github.com/WOA-Project/payload-dumper-go/releases/download/v1.3.0/payload-dumper-go_v1.3.0_linux_amd64.tar.gz

permissions:
  contents: write  # å¿…é¡»ï¼ç”¨äºåˆ›å»º GitHub Release

jobs:
  make:
    runs-on: ubuntu-latest
    steps:
      - name: Create working directory
        run: mkdir -p "$HOME/work"

      - name: Download payload-dumper-go (v1.3.0, HyperOS compatible)
        run: |
          cd "$HOME/work"
          wget --connect-timeout=10 --timeout=30 -O payload_dumper_go.tar.gz "$Payload_Dumper_Go_Url"

      - name: Extract payload-dumper-go
        run: |
          cd "$HOME/work"
          mkdir -p payload_dumper_go
          tar -xzf payload_dumper_go.tar.gz -C payload_dumper_go --strip-components=1
          chmod +x payload_dumper_go/payload-dumper-go

      - name: Verify payload-dumper-go
        run: |
          cd "$HOME/work/payload_dumper_go"
          ./payload-dumper-go --help

      - name: Download ROM
        run: |
          cd "$HOME/work"
          echo "ğŸ“¥ Downloading ROM from: ${{ github.event.inputs.ROM_URL }}"
          wget --connect-timeout=10 --timeout=120 -O rom.zip "${{ github.event.inputs.ROM_URL }}"

      - name: Extract ROM and locate payload.bin
        run: |
          cd "$HOME/work"
          mkdir -p rom_extracted
          unzip -q rom.zip -d rom_extracted
          find rom_extracted -type f -name "payload.bin" -exec cp {} payload_dumper_go/ \;
          if [ ! -f payload_dumper_go/payload.bin ]; then
            echo "âŒ ERROR: payload.bin not found!"
            find rom_extracted -type f | head -n 30
            exit 1
          fi
          echo "âœ… payload.bin copied."

      - name: List partitions in payload.bin (debug)
        run: |
          cd "$HOME/work/payload_dumper_go"
          echo "ğŸ” Available partitions:"
          ./payload-dumper-go -l payload.bin

      - name: Extract specified partitions (with verbose output)
        run: |
          cd "$HOME/work/payload_dumper_go"
          partitions="${{ github.event.inputs.PARTITIONS }}"
          
          # æ„å»ºå‚æ•°ï¼šæ”¯æŒå¤šä¸ªåˆ†åŒºï¼Œè‡ªåŠ¨ trim ç©ºæ ¼
          args=()
          IFS=',' read -ra PARTS <<< "$partitions"
          for part in "${PARTS[@]}"; do
            part=$(echo "$part" | xargs)
            if [ -n "$part" ]; then
              args+=("-p" "$part")
            fi
          done
          
          if [ ${#args[@]} -eq 0 ]; then
            echo "âŒ No valid partitions specified."
            exit 1
          fi
          
          echo "ğŸ”§ Extracting partitions: ${args[*]}"
          # å¯ç”¨ verbose æ¨¡å¼ (-v) ä»¥æŸ¥çœ‹è¯¦ç»†è¿‡ç¨‹
          ./payload-dumper-go -v -o . "${args[@]}" payload.bin

      - name: List all files after extraction (diagnostic)
        run: |
          cd "$HOME/work/payload_dumper_go"
          echo "ğŸ“ Files in extraction directory:"
          ls -la
          echo ""
          echo "ğŸ” Looking for .img files:"
          ls *.img 2>/dev/null || echo "âŒ No .img files found!"

      - name: Fail if no .img files were extracted
        run: |
          cd "$HOME/work/payload_dumper_go"
          shopt -s nullglob
          img_files=(*.img)
          if [ ${#img_files[@]} -eq 0 ]; then
            echo "ğŸ”´ Extraction completed but no .img files generated. Check ROM compatibility."
            exit 1
          else
            echo "ğŸŸ¢ Found ${#img_files[@]} image(s):"
            for f in "${img_files[@]}"; do
              echo "   - $f ($(stat -c%s "$f") bytes)"
            done
          fi

      - name: Upload to GitHub Artifacts (for debugging)
        if: ${{ github.event.inputs.UPLOAD_CONFIG == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: Extracted-Images
          path: ${{ runner.home }}/work/payload_dumper_go/*.img

      - name: Create GitHub Release and Upload Images
        if: ${{ github.event.inputs.UPLOAD_CONFIG == 'false' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "auto-${{ github.run_id }}-${{ github.run_number }}"
          name: "Extracted Images - Run #${{ github.run_number }}"
          body: |
            Partitions: `${{ github.event.inputs.PARTITIONS }}`
            Source ROM: `${{ github.event.inputs.ROM_URL }}`
            Workflow: [View logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          draft: false
          prerelease: false
          files: ${{ runner.home }}/work/payload_dumper_go/*.img
